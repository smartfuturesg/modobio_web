variables:
  GIT_DEPTH: 0

stages:
  - test
  - build
  - version
  - deploy

test:
  stage: test
  tags:
    - shared
  only:
    - merge_requests
  script:
    - sudo docker network create modobio
    - echo "Creating test database..."
    - sudo docker run --name postgres_$CI_BUILD_ID --network modobio -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=password -e POSTGRES_DB=modobio_test -p 5432:5432 -d postgres
    - echo "Running tests..."
    - bash ~/test_odyssey.sh
  after_script:
    - echo "Destroying test database..."
    - sudo docker rm -f postgres_$CI_BUILD_ID

pages:
  stage: build
  tags:
    - gitlab-runner
  only:
    - master
  script:
    - echo 'Nothing to do...'
  artifacts:
    paths:
      - public

version:
  stage: version
  tags:
    - shared
  only:
    - master
  script:
    - echo "Checking version"
    - bash ~/update_version.sh zan/odyssey

deploy:
  stage: deploy
  tags:
    - shared
  only:
    - master
  script:
    - echo "Deploying update."
    - bash ~/dev_update.sh odyssey